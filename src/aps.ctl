(define-param no-struc? true)
(use-output-directory "output")
(set! eps-averaging? true)
(define-param rot 0)
(define rot (* (/ rot 180) pi))

; morphology parameters
(define-param r 0.090)		; radius of melanosomes
(define-param a 0.190)		; spacing between melanosomes
(define-param cor 0)	; keratin cortex thickness
(define-param scale .0951) ; diameter of spheres from simulation

(define pad 4)
(define dpml 1)
(define mag (/ a scale))
; (define mag 1)

; points pattern from SPHERES program output
; (define xx #(0.135299137560651 -0.0147972297854722 -0.0470568938180804 -0.00407531741075218 -0.411480814917013 0.277973787859082 0.301084071164951 -0.347545521799475 0.425036702537909 -0.139200433390215 -0.0198695280123502 -0.407600877108052 -0.0987334146630019 0.416193647775799 0.0165846461895853 0.182184300851077 -0.367531448369846 -0.445722550619394 -0.45791064738296 0.38965718401596 0.386470369063318 0.194180521182716 0.100878504803404 -0.0620593384373933 0.293714667437598 0.287719944724813 0.47969086538069 -0.0957180552650243 0.107783951563761 0.212965761777014 -0.25345836346969 -0.0522347181104124 -0.0146682339254767 0.27830158197321 -0.00815632287412882 -0.277821327093989 -0.14167109131813 -0.416926313424483 -0.397656944580376 -0.10563826863654 0.0447083823382854 -0.29106137342751 0.138979965355247 0.403679276118055 -0.311557143460959 -0.0614936114288867 -0.27256891480647 0.214471919927746 -0.49250722839497 0.496255276957527 0.367244217311963 -0.354233466088772 0.0548336256761104 -0.0730071642901748 0.100205320632085 -0.374370567966253 0.497661031782627 0.459071347489953 0.0911633872892708 0.242908492917195 -0.373538353014737 -0.16315554222092 -0.497661031782627 -0.477104254066944 0.347231074469164 -0.472450163913891 -0.1989132524468 0.156029507983476 0.424840455409139 0.188065598485991 0.225857204757631 0.329664688091725 -0.00291113881394267 -0.143520804354921 0.493637475417927 -0.0275461992714554 0.123515845509246 -0.0531644856091589 -0.18936598720029 -0.24495343095623 0.293790251715109 0.468174674548209 0.0370131726376712 -0.467478816397488 -0.191758146276698 0.0842665657401085 0.0509521383792162 0.115614636801183 -0.278041837736964 0.215588433435187 -0.401649727951735 0.30815131124109 -0.392468115082011 -0.196596463443711 -0.357034680666402 -0.164521772880107 0.00587342469953001 0.429775882512331 -0.139796073548496 0.345189746469259))
; (define yy #(0.0169463949277997 0.348335094051436 0.172285398934036 0.486932198284194 0.124004749115556 -0.180026004556566 0.103636075044051 0.206183081958443 0.159226246876642 -0.389697396894917 -0.399717429419979 0.399846615968272 -0.179637682391331 0.331299467943609 -0.442928956821561 -0.183546314714476 0.467044832650572 0.487142508849502 0.0927939531393349 0.0150306867435575 -0.160730840405449 0.325018434785306 -0.264559642644599 0.307417792733759 0.482682958478108 0.220054277218878 -0.239343524212018 -0.0806960929185152 -0.348188225179911 0.466877469560131 0.044839619891718 -0.473173919133842 -0.286459560506046 -0.258858295856044 0.428403033642098 0.247459049103782 -0.231072945520282 0.00893927947618067 -0.301023378269747 0.0581165996845812 0.17874494055286 0.164877376519144 0.423653673147783 -0.46654226235114 -0.163113154470921 -0.130926813464612 0.486200508428738 -0.104525848524645 -0.0973428427241743 0.18245309824124 0.431498552905396 -0.433754484169185 0.00140436692163348 0.42237852094695 -0.0312530731316656 -0.0762681814376265 -0.361383246956393 -0.0388204825576395 -0.145050529390574 0.362416856456548 0.084041585912928 0.319578194292262 -0.264218563912436 -0.487142508849502 0.228880228009075 0.29879436432384 -0.243490933440626 -0.0718655937816948 0.216614634264261 0.385604670969769 0.212389620253816 -0.453938911668956 -0.203774878755212 0.480748642701656 0.099617853295058 0.0847750890534371 0.228457968216389 -0.224285948788747 0.426805659197271 0.383501642616466 0.0368615395855159 -0.430069238413125 0.380135048180819 0.376751590985805 -0.437320322729647 0.0440140594728291 -0.203650407493114 0.108601138927042 -0.0132921626791358 -0.0107339296955615 0.183350217528641 -0.0799725686665624 -0.392560947919264 0.207954348064959 -0.252473959000781 -0.126054997555912 0.21755016152747 -0.329203016590327 0.234558060765266 0.485465885372832))

(define xx #(0.253721589796731 0.443974845113779 -0.266449971198885 0.477916041442686 -0.208718040399147 -0.142755307373942 0.0636758409610534 0.0774862935737269 0.251136477889075 0.457423444282046 0.327863305558317 0.177811665501811 -0.227411269256647 0.267901731938199 -0.132548819525556 -0.11708183847462 -0.310342101482179 -0.388826446190251 -0.0342894820632622 -0.173697367223243 0.139237340015071 -0.00403292606636402 0.246358595974482 0.0541623013364146 -0.114840226839771 0.261457866683275 0.168877550151261 0.160489544165094 -0.427913995990883 -0.199042761063009 -0.307458533255085 -0.491742652632552 0.0768490610706697 0.104651698099888 0.335865713615314 0.317680926079999 -0.013677125272143 0.322186296130776 0.435718957967058 0.430493964557745 -0.409519229987815 -0.401285926315152 0.377840548704562 -0.191359023188754 0.422329124076288 -0.38316479925014 -0.476520992725468 0.339876410256242 -0.208662442955124 0.377545502368018 -0.320695857812707 0.0645477818659254 0.167106325136336 0.243104393028097 -0.289898096445386 0.412878665897684 -0.22078165664232 -0.371125170466986 -0.473475253113796 -0.135626028490094 -0.0767799427948529 -0.213042141968185 -0.334951734971767 -0.256952232167995 -0.382889552863091 0.00679275256468759 0.343128362980161 -0.0131180864139649 0.222729130220604 0.166712723849441 -0.0221568105153338 -0.113372433532146 -0.0809814278403544 0.235316856836267 -0.105895594354096 -0.290544128292419 0.412416103223266 0.0424889599663918 0.159864929810552 0.492837435877535 -0.476189236003723 -0.0370436593667459 0.0810720260397785 0.246320270273189 -0.115343210242869 0.341484481726023 -0.480893282914931 -0.410057235150348 -0.469919704265876 -0.032090438881681 -0.313636829498153 -0.398336369980463 0.351652821491013 0.0167419939034449 0.133043823223961 -0.492837435877535 0.14760767052164 -0.352544294735124 -0.294617092597644 0.0861306503168918))
(define yy #(0.39369500744872 0.0334627508661646 0.0701738479887097 0.378931458400354 -0.116458874695776 -0.0185502000424823 -0.380816136862156 0.0313306833158248 -0.164030255953142 -0.345377897476196 -0.329222917496771 -0.346305912751637 -0.260151216950781 -0.410446710286413 -0.303247896124841 0.374747678696605 -0.332756813936117 0.493426772452769 0.327782804417624 0.0928620709151918 0.438308258201203 -0.12147355304954 -0.0677967848847918 0.392832136782016 0.497111121601517 0.0524763256397672 -0.223743616828145 -0.0213172533210317 -0.381063839298182 0.426311734745534 0.3717728444187 -0.259105531951453 -0.0685444989859088 0.158236279155036 -0.231259322416184 -0.497111121601517 -0.0198415849496545 0.310804901210087 0.142016029098983 -0.0613125684207456 -0.191090073587067 -0.0837414562045813 -0.415743954824172 0.19198432842894 -0.191176805166338 0.308142540440981 0.284045423154082 0.215511986840279 -0.474197959735315 0.394423063415727 -0.232176497393885 0.297532521040433 0.082690345662614 0.251611957212051 0.165778020422615 0.490246531607909 -0.37749528855693 0.108577737445668 -0.0164237222223509 0.272925908070916 0.0513457114191599 0.331670120902357 -0.425917865053902 -0.0273579208618382 0.20521983388182 0.0997923683524279 -0.135553771820629 -0.221037921633353 0.489360594593221 0.345531996337723 -0.433299052963269 -0.208093701845813 0.155236054845395 0.149320499732254 -0.106583878141155 0.266635232673949 0.278295850769021 0.490526198069032 -0.118165628974 -0.438982838447867 0.18095962933506 0.427579921247562 -0.174480557552778 -0.279592309109691 -0.407431132415496 0.118089638271627 0.467491053065262 0.399824007064792 0.0836522767459794 -0.330422153663555 -0.128133351337596 -0.290667436007448 -0.00455123512742545 0.205293708645489 -0.46617333991412 -0.132141095741476 0.249158154191637 0.010699851117846 0.477137798951156 -0.288186533230769))

; cell size
(define sx0 1) ; width of original image
(define sy0 1) ; height of original image
(define sx (+ sx0 (* 2 dpml)))
(define sy (+ (* pad 2) sy0 (* 2 dpml)))

; simulation parameters
(define fcen 2.4)
(define df 4)
(define nfreq 400)

(set! geometry-lattice (make lattice (size sx sy no-size)))

; material properties
(define-param n1 1.56)
(define-param n2 2.00)
(define-param n3 1.56)
(define eps1 (* n1 n1)) ; permittivity of material 1 (low index)
(define eps2 (* n2 n2)) ; permittivity of material 2 (high index)
(define eps3 (* n3 n3))	; permittivity of material 3 (b/w melanosomes)
(define-param k1 0)	; extinction coeff mat 1
(define-param k2 0.01)	; extinction coeff mat 2
(define-param k3 0.01)	; extinction coeff of material b/w mels

(define mat1 (make medium (epsilon eps1) (D-conductivity (/ (* 2 pi fcen (* 2 (sqrt eps1) k1)) eps1))))
(define mat2 (make medium (epsilon eps2) (D-conductivity (/ (* 2 pi fcen (* 2 (sqrt eps2) k2)) eps2))))
(define mat3 (make medium (epsilon eps3) (D-conductivity (/ (* 2 pi fcen (* 2 (sqrt eps3) k3)) eps3))))

(set! default-material mat1) ; changed from mat3

; I think this worked at creating a geometry with cylinders at the (x,y)
; coordinates specified by the vectors xx and yy
(define (doit x x-max dx)
	(if (<= x x-max)
 	  (begin
		(set! geometry (append geometry
			(list 
			 ;(make block
	  	 		;(center 0 (- (* 0.5 sy) (- (/ (+ dpml pad) 2) cor)))
	  	   		;(size sx (+ dpml pad) infinity) (material mat1))
			 ;(make block
	  	 		;(center 0 (- (* 0.5 sy) (- (+ dpml pad) r (/ cor 2))))
	  	   		;(size sx cor) (material mat1))
			 (make cylinder
				(center 
					(+ (* (vector-ref xx x) (cos rot) mag) (* (vector-ref yy x) (sin rot) mag))
					(+ (* (* (vector-ref xx x) -1) (sin rot) mag) (* (vector-ref yy x) (cos rot) mag)))
				 (radius r) (height infinity)
  				 (material mat2)))))
		(doit (+ x dx) x-max dx))))

; define geometry
(if no-struc?
	(set! geometry (list 
		(make block (center 0 0) (size sx sy infinity) (material mat1))))
	(doit 0 99 1)) ; do loop from a to b in steps of dx

; excite sources
(set! sources (list
	 (make source
	  (src (make gaussian-src (frequency fcen) (fwidth df)))
	    (component Ez)
		(center 0 (- (* 0.5 sy) dpml 1))
		(size sx 0))))

(set! pml-layers (list (make pml (thickness 1.0))))
;(set! pml-layers (list (make pml (direction Y) (thickness dpml)))) ; only on Y extremes

(define-param res 50)
(set! resolution res)
(set! k-point (vector3 0 0 0))
;(set! ensure-periodicity true)

; define flux regions (planes)
(define refl ; reflected flux
	(add-flux fcen df nfreq
	 (make flux-region
	  (center 0 (- (* 0.5 sy) dpml 2)) (size (* sx 2) 0))))

(define trans ; transmitted flux
	(add-flux fcen df nfreq
	 (make flux-region
	 (center 0 (+ (* -0.5 sy) dpml 1)) (size (* sx 2) 0)))) ; changed from (* sy2)

(if (not no-struc?) (load-minus-flux "refl-flux" refl))

(run-sources+
	(stop-when-fields-decayed 50 Ez
		(vector3 0 (- (* 0.5 sy) dpml 1))
		1e-2)
	(at-beginning output-epsilon)
	(at-end (output-png Ez "-Zc bluered")))

;(run-until 10
;	(at-beginning output-epsilon)
;	(at-every 1 (output-png Ez "-Zc bluered"))
;	(at-end output-efield-z))

(if no-struc? (save-flux "refl-flux" refl))
(display-fluxes trans refl) ; print out the flux spectrum